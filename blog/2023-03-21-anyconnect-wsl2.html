<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <link rel="icon" href="/swim-emoji.png" />
    <link rel="manifest" href="/manifest.json" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Fira+Code:wght@400;700&display=swap"
      rel="stylesheet"
    />
    <link
      rel="alternate"
      type="application/rss+xml"
      title="tiim.ch Â» Tim Bachmann"
      href="/blog/rss.xml"
    />
    <link href="https://comments.tiim.ch/wm/webmentions" rel="webmention" />
    <link
      href="https://comments.tiim.ch/indieauth/metadata"
      rel="indieauth-metadata"
    />
    <link
      href="https://comments.tiim.ch/indieauth/authorize"
      rel="authorization_endpoint"
    />
    <link
      href="https://comments.tiim.ch/indieauth/token"
      rel="token_endpoint"
    />
    <link rel="micropub" href="https://comments.tiim.ch/micropub" />
    <link rel="microsub" href="https://aperture.p3k.io/microsub/801" />
    <title>Tim Bachmann</title>
    
		<link href="../_app/immutable/assets/0.8d503a92.css" rel="stylesheet">
		<link href="../_app/immutable/assets/4.32b0d823.css" rel="stylesheet">
		<link href="../_app/immutable/assets/MarkdownSite.52351ed7.css" rel="stylesheet">
		<link rel="modulepreload" href="../_app/immutable/entry/start.5c58580c.js">
		<link rel="modulepreload" href="../_app/immutable/chunks/index.8c1dbec0.js">
		<link rel="modulepreload" href="../_app/immutable/chunks/singletons.195a5806.js">
		<link rel="modulepreload" href="../_app/immutable/chunks/paths.ee001647.js">
		<link rel="modulepreload" href="../_app/immutable/entry/app.8dd63c07.js">
		<link rel="modulepreload" href="../_app/immutable/nodes/0.9334d053.js">
		<link rel="modulepreload" href="../_app/immutable/chunks/mf2.47734ed4.js">
		<link rel="modulepreload" href="../_app/immutable/nodes/4.657d6c5d.js">
		<link rel="modulepreload" href="../_app/immutable/chunks/MarkdownSite.88130736.js">
		<link rel="modulepreload" href="../_app/immutable/chunks/fa.9f83fec8.js"><title>Fix Network Connectivity in WSL2 with Cisco AnyConnect VPN - Tim Bachmann</title><!-- HEAD_svelte-1ula76m_START --><meta property="og:title" content="Fix Network Connectivity in WSL2 with Cisco AnyConnect VPN"><meta property="og:type" content="article"><meta property="og:description" content="I ran into problems using Cisco AnyConnect VPN from inside of WSL2. I'm sharing my solution as a step-by-step guide for my reference and to help anyone with the same problem."><meta property="article:published_time" content="Wed Mar 15 2023 15:22:04 GMT+0000 (Coordinated Universal Time)"><meta property="article:modified_time" content="Wed Mar 15 2023 15:22:04 GMT+0000 (Coordinated Universal Time)"><meta property="article:author" content="Tim Bachmann"><meta property="article:tag" content="dns"><meta property="article:tag" content="networking"><meta property="article:tag" content="vpn"><meta property="article:tag" content="wsl"><meta property="og:image" content="https://media.tiim.ch/66ca4290-3fc0-450f-977b-f00f888e4af3.webp"><!-- HEAD_svelte-1ula76m_END -->
  </head>
  <body>
    <div id="svelte">


<div id="app"><nav class="navbar svelte-1qkwc1i" aria-label="main navigation"><div class="navbar-brand svelte-1qkwc1i"><a class="navbar-item svelte-1qkwc1i" href="/">Tim Bachmann</a></div>
  <div class="navbar-menu desktop svelte-1qkwc1i"><a href="/" class="navbar-item svelte-1qkwc1i">Home</a>
    <a href="/projects" class="navbar-item svelte-1qkwc1i">Projects</a>
    <a href="/blog" class="navbar-item svelte-1qkwc1i">Blog</a>
    <a href="/pages/uses" class="navbar-item svelte-1qkwc1i">Uses</a>
    <a class="navbar-item svelte-1qkwc1i" href="/contact">Contact</a>
    <a class="navbar-item svelte-1qkwc1i" href="/follow">Follow</a></div>
  <div class="navbar-menu mobile svelte-1qkwc1i"><div><input id="header-toggle" class="header-checkbox svelte-1qkwc1i" type="checkbox">
      <label for="header-toggle" class="toggle svelte-1qkwc1i"><span class="svelte-1qkwc1i"></span>
        <span class="svelte-1qkwc1i"></span>
        <span class="svelte-1qkwc1i"></span></label></div>
    </div>
</nav>
  <div class="section">

<div><article class="container h-entry"><figure class="svelte-1vgyhou"><img alt="Fix Network Connectivity in WSL2 with Cisco AnyConnect VPN" src="https://media.tiim.ch/66ca4290-3fc0-450f-977b-f00f888e4af3.webp" class="svelte-1vgyhou">
        <figcaption class="svelte-1vgyhou">Stable Diffusion - Anything V3.0 - 1boy, hacker, in front of computer, back of head visible, vintage neon color scheme, terminal, big monitor</figcaption></figure>

    <h1><span class="p-name">Fix Network Connectivity in WSL2 with Cisco AnyConnect VPN</span></h1>
    

    <p class="tags"><a class="tag p-category" href="/tags/dns">dns
        </a><a class="tag p-category" href="/tags/networking">networking
        </a><a class="tag p-category" href="/tags/vpn">vpn
        </a><a class="tag p-category" href="/tags/wsl">wsl
        </a></p>

    <div class="by svelte-1vgyhou"><address class="author svelte-1vgyhou">by <a href="/" rel="author">Tim Bachmann</a></address>
      <span>published on <time pubdate datetime="2023-03-15T15:22:04.511Z" class="date dt-published">Wednesday, March 15, 2023</time></span>
</div>

    
    <div class="e-content content svelte-1vgyhou"><!-- HTML_TAG_START --><p>I recently ran into the problem that when the Cisco AnyConnect VPN is connected, the network connectivity inside of WSL2 stops working. I found a bunch of solutions online for it: most just focus on the fact that the VPN DNS settings are not applied inside WSL2 and therefore no domain names can be resolved. I additionally had the issue that the WSL2 network interface somehow gets disconnected when the VPN starts.</p>
<p>I will show you how I fixed this problem for me and explain what the commands I used do. This post is mostly for my reference, but I hope it helps anyone else as well.</p>
<h2>Finding out what your problem is</h2>
<p>Let's check first if we have internet access inside WSL2. For this run the ping command with an IP address as a destination:</p>
<pre><code class="language-sh">ping 8.8.8.8
</code></pre>
<p>If you get something like this as the output, your internet connection is fine, and it's just the DNS nameserver addresses that are misconfigured, you can jump forward to Solution 2.</p>
<pre><code>PING 8.8.8.8 (8.8.8.8) 56(84) bytes of data.
64 bytes from 8.8.8.8: icmp_seq=1 ttl=108 time=4.53 ms
64 bytes from 8.8.8.8: icmp_seq=2 ttl=108 time=3.94 ms
64 bytes from 8.8.8.8: icmp_seq=3 ttl=108 time=3.97 ms
64 bytes from 8.8.8.8: icmp_seq=4 ttl=108 time=3.78 ms
64 bytes from 8.8.8.8: icmp_seq=5 ttl=108 time=3.77 ms
64 bytes from 8.8.8.8: icmp_seq=6 ttl=108 time=3.76 ms
64 bytes from 8.8.8.8: icmp_seq=7 ttl=108 time=3.81 ms
</code></pre>
<p>If you don't get any responses from the ping (i.e. no more output after the <code>PING 8.8.8.8 (8.8.8.8) ...</code> line), you need to configure the WSL and the VPN network adapter metric. Go to Solution 1.</p>
<p>To check if the DNS is working, we can again use the ping command, this time with a domain name:</p>
<pre><code class="language-sh">ping google.com
</code></pre>
<p>If you get responses, the DNS and your internet connection are working! If not go to Section 2.</p>
<h2>Solution 1: Fixing the Network Adapter</h2>
<p>Run the following two commands in PowerShell as administrator:</p>
<pre><code class="language-PowerShell">Get-NetAdapter | Where-Object {$_.InterfaceDescription -Match "Cisco AnyConnect"} | Set-NetIPInterface -InterfaceMetric 4000

Get-NetIPInterface -InterfaceAlias "vEthernet (WSL)" | Set-NetIPInterface -InterfaceMetric 1
</code></pre>
<p>Let me explain what those two commands do. Both follow the same pattern of listing all network adapters, selecting a specific adapter from the list and setting its "metric".</p>
<p>You can imagine an adapter as a virtual network port on the back of your pc or laptop. But instead of sending packets through the wire, the driver for a specific port can do whatever it wants with those packets, in the case of a VPN, the packets get encrypted and forwarded to the internet via another adapter.</p>
<p>The <a href="https://learn.microsoft.com/en-us/windows-server/networking/technologies/network-subsystem/net-sub-interface-metric" rel="nofollow noopener noreferrer">InterfaceMetric</a> is a value associated with each adapter that determines the order of those adapters. This allows windows to determine which adapter to prefer over another one.</p>
<p>By setting the interface metric of the Cisco adapter to 4000 and the metric of the WSL adapter to one, we allow the traffic from WSL to flow through the Cisco adapter. To be honest I do not exactly understand why this works but it does.</p>
<h2>Solution 2: Registering the VPN DNS inside of WSL</h2>
<p>Setting the DNS servers is, unfortunately, a little bit more involved than just running two commands, we need to edit the files <code>/etc/wsl.conf</code> and <code>/etc/resolv.conf</code>, and restart wsl in between. Let's get to it:</p>
<p>Edit the file <code>/etc/wsl.conf</code> inside of WSL2 using a text editor. I suggest doing this through the terminal since you need root permissions to do that:</p>
<pre><code class="language-sh">sudo nano /etc/wsl.conf
# feel free to use another editor such as vim or emacs
</code></pre>
<p>Most likely this file does not exist yet, otherwise, I suggest you create a backup of the original file to preserve the settings.</p>
<p>Add the following config settings into the file:</p>
<pre><code class="language-ini">[network]
generateResolvConf = false
</code></pre>
<p>This will instruct WSL to not override the <code>/etc/resolv.conf</code> file on every start-up. Save the file and restart WSL with the following command so that the changed config takes effect:</p>
<pre><code class="language-sh">wsl.exe --shutdown
</code></pre>
<p>Now open a PowerShell terminal and list all network adapters with the following command:</p>
<pre><code class="language-PowerShell">ipconfig /all
</code></pre>
<p>Find the Cisco AnyConnect adapter and copy the IP addresses in the DNS-Server field. We will need those IPs in the next step.</p>
<p>Start WSL again and edit the <code>/etc/resolv.conf</code> file:</p>
<pre><code class="language-sh">sudo nano /etc/resolv.conf
</code></pre>
<p>Most likely there is already something in this file, you can discard it. When undoing the changes, WSL will automatically regenerate this file anyway, so you don't need to back it up.</p>
<p>Delete all the contents and enter the IP addresses you noted down in the last step in the following format:</p>
<pre><code class="language-resolv">nameserver xxx.xxx.xxx.xxx
</code></pre>
<p>Put each address on a new line, preceded by the string <code>nameserver</code>.
Save the file and restart WSL with the same command as above:</p>
<pre><code class="language-sh">wsl.exe --shutdown
</code></pre>
<p>Now open up WSL for the last time and set the immutable flag for the <code>/etc/resolv.conf</code> file:</p>
<pre><code class="language-sh">chattr +i /etc/resolv.conf
</code></pre>
<p>And for the last time shut down WSL. Your DNS should now be working fine!</p>
<h2>Undoing those changes</h2>
<p>I did not have a need to undo the steps for <code>Solution 1</code>, and I'm pretty sure the metric resets after each system reboot anyway so there is not much to do.</p>
<p>To get DNS working again when not connected to the VPN run the following commands:</p>
<pre><code class="language-sh">sudo chattr -i /etc/resolv.conf
sudo rm /etc/resolv.conf
sudo rm /etc/wsl.conf
wsl.exe --shutdown
</code></pre>
<p>This will first clear the immutable flag off <code>/etc/resolv.conf</code>, and delete it. Next, it will delete <code>/etc/wsl.conf</code> if you have a backup of a previous <code>wsl.conf</code> file, you can replace it with that. At last, we shutdown WSL again for the changes to take effect.</p>
<p>Unfortunately, this is quite a procedure to get a VPN to work with WSL2, but I'm hopeful that this will soon not be necessairy anymore.</p><!-- HTML_TAG_END --></div>

    

    <div class="outro svelte-1ysgxol" slot="outro"><em>You found an error in this post? Open a
      <a href="https://github.com/Tiim/Tiim.github.io/tree/source/content/blog/2023-03-21-anyconnect-wsl2.md">pull request</a>.
    </em></div>

    <div class="author-info p-author h-card svelte-gqjfyc"><div class="author-avatar svelte-gqjfyc"><img src="https://media.tiim.ch/tiim.jpg" alt="Photo of Tim Bachmann" class="u-photo svelte-gqjfyc"></div>
  <div><p class="author-bio p-note"><!-- HTML_TAG_START --><p>Hi, my name is <span class="p-name">Tim Bachmann</span>!
I'm a <span class="p-role">master graduate in computer science</span> at <span class="p-org">University of Basel</span>, swimmer and swim coach.</p>
<p>I am passionate about all things web development, swimming, personal knowledge management and much more.
If you liked this or any of my posts, feel free to <a href="https://tiim.ch/follow" rel="nofollow noopener noreferrer">follow me</a>.</p><!-- HTML_TAG_END --></p>
    <div class="author-detail svelte-gqjfyc"><span class="hidden p-gender-identity svelte-gqjfyc">male</span>
      <a href="mailto:hey@tiim.ch" class="p-email">hey@tiim.ch</a>
      <a class="p-url" href="https://tiim.ch/">https://tiim.ch/</a></div></div>
</div>

    <div class="post-details"><p class="hidden p-summary svelte-1vgyhou">I ran into problems using Cisco AnyConnect VPN from inside of WSL2. I'm sharing my solution as a step-by-step guide for my reference and to help anyone with the same problem.</p>
      <a class="hidden p-url p-uid svelte-1vgyhou" href="/blog/2023-03-21-anyconnect-wsl2">/blog/2023-03-21-anyconnect-wsl2</a></div></article>
  <div class="container"><h2 class="svelte-z0478z">1 Comments and Interactions</h2>
<span>Leave a comment or interact with this page via
  <a href="http://indieweb.org/webmention">WebMention </a></span>
<div class="comment-form-wrap"><div id="comment-section" class="comment-input svelte-1xby3i5"><span class="avatar svelte-1xby3i5">
<!-- HTML_TAG_START --><!-- HTML_TAG_END --></span>
    <div class="comment-input-content svelte-1xby3i5"><label for="comment-input-name">Name</label>
      <input id="commentName" type="text" placeholder="Name">
      <div class="comment-input-content svelte-1xby3i5"><label for="comment-input-email">E-mail</label>
        <div class="horizontal svelte-1xby3i5"><input id="commentEmail" type="email" placeholder="Email (optional)">
          <div class="checkbox svelte-1xby3i5"><input type="checkbox" id="comment-input-notify" class="svelte-1xby3i5">
            <label for="comment-input-notify">Notify me on replies</label></div></div></div>
      
      <label for="commentContent">Comment</label>
      <textarea id="commentContent" placeholder="Comment" class="svelte-1xby3i5"></textarea>
      <button>Post</button>
      </div></div>
</div>
<ul class="comment-list svelte-z0478z"><li class="comment svelte-z0478z"><span class="avatar svelte-z0478z">
<!-- HTML_TAG_START --><!-- HTML_TAG_END --></span>
      <div class="comment-card svelte-z0478z"><div class="comment-header svelte-z0478z"><h3 id="ebe11171-5e39-450b-bfad-e976f7659489" class="svelte-z0478z">Neil</h3>
          <span class="time svelte-z0478z"><a href="https://tiim.ch/blog/2023-03-21-anyconnect-wsl2#ebe11171-5e39-450b-bfad-e976f7659489">2024-01-12 12:11:32 PM
            </a></span>
          <span class="reply-notice svelte-z0478z"></span>
          <span><button class="svelte-z0478z">Reply</button>
            </span></div>
        
        <p class="comment-content svelte-z0478z">Thank you Tim! Had an issue where WSL network was working for some users and not others when using Cisco AnyConnect, network traffic seemed to go back to the AnyConnect interface and didn't reach WSL. Solution 1 did the trick for me!</p></div>
    </li>
</ul></div>
</div></div>
  <div><footer class="svelte-18j7aqw"><div><!-- HTML_TAG_START --><p>Built with SvelteKit and hosted on GitHub Pages.</p>
<p>View this website on <a href="https://github.com/Tiim/Tiim.github.io" rel="nofollow noopener noreferrer">GitHub</a>!</p>
<h2>Other pages</h2>
<ul>
<li><a href="https://tiim.ch/pages/links" rel="nofollow noopener noreferrer">Links and Blogroll</a></li>
</ul><!-- HTML_TAG_END --></div>
  <p class="copyright svelte-18j7aqw">Â©Tim Bachmann 2024</p>
</footer></div></div>


			
			<script>
				{
					__sveltekit_h39q7n = {
						base: new URL("..", location).pathname.slice(0, -1),
						env: {}
					};

					const element = document.currentScript.parentElement;

					const data = [{"type":"data","data":{footer:{html:"\u003Cp>Built with SvelteKit and hosted on GitHub Pages.\u003C/p>\n\u003Cp>View this website on \u003Ca href=\"https://github.com/Tiim/Tiim.github.io\" rel=\"nofollow noopener noreferrer\">GitHub\u003C/a>!\u003C/p>\n\u003Ch2>Other pages\u003C/h2>\n\u003Cul>\n\u003Cli>\u003Ca href=\"https://tiim.ch/pages/links\" rel=\"nofollow noopener noreferrer\">Links and Blogroll\u003C/a>\u003C/li>\n\u003C/ul>",slug:"footer",uuid:"e556fd14-3acd-4a7b-9b31-929fdd6d2b7a",created:new Date(1690834579000),date:new Date(1690834579000),published:true,abstract:"\u003Cp>Built with SvelteKit and hosted on GitHub Pages.\u003C/p>",tags:[],links:void 0,type:"article",cover_image:void 0,description:"",folder:"metadata"}},"uses":{}},{"type":"data","data":{post:{html:"\u003Cp>I recently ran into the problem that when the Cisco AnyConnect VPN is connected, the network connectivity inside of WSL2 stops working. I found a bunch of solutions online for it: most just focus on the fact that the VPN DNS settings are not applied inside WSL2 and therefore no domain names can be resolved. I additionally had the issue that the WSL2 network interface somehow gets disconnected when the VPN starts.\u003C/p>\n\u003Cp>I will show you how I fixed this problem for me and explain what the commands I used do. This post is mostly for my reference, but I hope it helps anyone else as well.\u003C/p>\n\u003Ch2>Finding out what your problem is\u003C/h2>\n\u003Cp>Let's check first if we have internet access inside WSL2. For this run the ping command with an IP address as a destination:\u003C/p>\n\u003Cpre>\u003Ccode class=\"language-sh\">ping 8.8.8.8\n\u003C/code>\u003C/pre>\n\u003Cp>If you get something like this as the output, your internet connection is fine, and it's just the DNS nameserver addresses that are misconfigured, you can jump forward to Solution 2.\u003C/p>\n\u003Cpre>\u003Ccode>PING 8.8.8.8 (8.8.8.8) 56(84) bytes of data.\n64 bytes from 8.8.8.8: icmp_seq=1 ttl=108 time=4.53 ms\n64 bytes from 8.8.8.8: icmp_seq=2 ttl=108 time=3.94 ms\n64 bytes from 8.8.8.8: icmp_seq=3 ttl=108 time=3.97 ms\n64 bytes from 8.8.8.8: icmp_seq=4 ttl=108 time=3.78 ms\n64 bytes from 8.8.8.8: icmp_seq=5 ttl=108 time=3.77 ms\n64 bytes from 8.8.8.8: icmp_seq=6 ttl=108 time=3.76 ms\n64 bytes from 8.8.8.8: icmp_seq=7 ttl=108 time=3.81 ms\n\u003C/code>\u003C/pre>\n\u003Cp>If you don't get any responses from the ping (i.e. no more output after the \u003Ccode>PING 8.8.8.8 (8.8.8.8) ...\u003C/code> line), you need to configure the WSL and the VPN network adapter metric. Go to Solution 1.\u003C/p>\n\u003Cp>To check if the DNS is working, we can again use the ping command, this time with a domain name:\u003C/p>\n\u003Cpre>\u003Ccode class=\"language-sh\">ping google.com\n\u003C/code>\u003C/pre>\n\u003Cp>If you get responses, the DNS and your internet connection are working! If not go to Section 2.\u003C/p>\n\u003Ch2>Solution 1: Fixing the Network Adapter\u003C/h2>\n\u003Cp>Run the following two commands in PowerShell as administrator:\u003C/p>\n\u003Cpre>\u003Ccode class=\"language-PowerShell\">Get-NetAdapter | Where-Object {$_.InterfaceDescription -Match \"Cisco AnyConnect\"} | Set-NetIPInterface -InterfaceMetric 4000\n\nGet-NetIPInterface -InterfaceAlias \"vEthernet (WSL)\" | Set-NetIPInterface -InterfaceMetric 1\n\u003C/code>\u003C/pre>\n\u003Cp>Let me explain what those two commands do. Both follow the same pattern of listing all network adapters, selecting a specific adapter from the list and setting its \"metric\".\u003C/p>\n\u003Cp>You can imagine an adapter as a virtual network port on the back of your pc or laptop. But instead of sending packets through the wire, the driver for a specific port can do whatever it wants with those packets, in the case of a VPN, the packets get encrypted and forwarded to the internet via another adapter.\u003C/p>\n\u003Cp>The \u003Ca href=\"https://learn.microsoft.com/en-us/windows-server/networking/technologies/network-subsystem/net-sub-interface-metric\" rel=\"nofollow noopener noreferrer\">InterfaceMetric\u003C/a> is a value associated with each adapter that determines the order of those adapters. This allows windows to determine which adapter to prefer over another one.\u003C/p>\n\u003Cp>By setting the interface metric of the Cisco adapter to 4000 and the metric of the WSL adapter to one, we allow the traffic from WSL to flow through the Cisco adapter. To be honest I do not exactly understand why this works but it does.\u003C/p>\n\u003Ch2>Solution 2: Registering the VPN DNS inside of WSL\u003C/h2>\n\u003Cp>Setting the DNS servers is, unfortunately, a little bit more involved than just running two commands, we need to edit the files \u003Ccode>/etc/wsl.conf\u003C/code> and \u003Ccode>/etc/resolv.conf\u003C/code>, and restart wsl in between. Let's get to it:\u003C/p>\n\u003Cp>Edit the file \u003Ccode>/etc/wsl.conf\u003C/code> inside of WSL2 using a text editor. I suggest doing this through the terminal since you need root permissions to do that:\u003C/p>\n\u003Cpre>\u003Ccode class=\"language-sh\">sudo nano /etc/wsl.conf\n# feel free to use another editor such as vim or emacs\n\u003C/code>\u003C/pre>\n\u003Cp>Most likely this file does not exist yet, otherwise, I suggest you create a backup of the original file to preserve the settings.\u003C/p>\n\u003Cp>Add the following config settings into the file:\u003C/p>\n\u003Cpre>\u003Ccode class=\"language-ini\">[network]\ngenerateResolvConf = false\n\u003C/code>\u003C/pre>\n\u003Cp>This will instruct WSL to not override the \u003Ccode>/etc/resolv.conf\u003C/code> file on every start-up. Save the file and restart WSL with the following command so that the changed config takes effect:\u003C/p>\n\u003Cpre>\u003Ccode class=\"language-sh\">wsl.exe --shutdown\n\u003C/code>\u003C/pre>\n\u003Cp>Now open a PowerShell terminal and list all network adapters with the following command:\u003C/p>\n\u003Cpre>\u003Ccode class=\"language-PowerShell\">ipconfig /all\n\u003C/code>\u003C/pre>\n\u003Cp>Find the Cisco AnyConnect adapter and copy the IP addresses in the DNS-Server field. We will need those IPs in the next step.\u003C/p>\n\u003Cp>Start WSL again and edit the \u003Ccode>/etc/resolv.conf\u003C/code> file:\u003C/p>\n\u003Cpre>\u003Ccode class=\"language-sh\">sudo nano /etc/resolv.conf\n\u003C/code>\u003C/pre>\n\u003Cp>Most likely there is already something in this file, you can discard it. When undoing the changes, WSL will automatically regenerate this file anyway, so you don't need to back it up.\u003C/p>\n\u003Cp>Delete all the contents and enter the IP addresses you noted down in the last step in the following format:\u003C/p>\n\u003Cpre>\u003Ccode class=\"language-resolv\">nameserver xxx.xxx.xxx.xxx\n\u003C/code>\u003C/pre>\n\u003Cp>Put each address on a new line, preceded by the string \u003Ccode>nameserver\u003C/code>.\nSave the file and restart WSL with the same command as above:\u003C/p>\n\u003Cpre>\u003Ccode class=\"language-sh\">wsl.exe --shutdown\n\u003C/code>\u003C/pre>\n\u003Cp>Now open up WSL for the last time and set the immutable flag for the \u003Ccode>/etc/resolv.conf\u003C/code> file:\u003C/p>\n\u003Cpre>\u003Ccode class=\"language-sh\">chattr +i /etc/resolv.conf\n\u003C/code>\u003C/pre>\n\u003Cp>And for the last time shut down WSL. Your DNS should now be working fine!\u003C/p>\n\u003Ch2>Undoing those changes\u003C/h2>\n\u003Cp>I did not have a need to undo the steps for \u003Ccode>Solution 1\u003C/code>, and I'm pretty sure the metric resets after each system reboot anyway so there is not much to do.\u003C/p>\n\u003Cp>To get DNS working again when not connected to the VPN run the following commands:\u003C/p>\n\u003Cpre>\u003Ccode class=\"language-sh\">sudo chattr -i /etc/resolv.conf\nsudo rm /etc/resolv.conf\nsudo rm /etc/wsl.conf\nwsl.exe --shutdown\n\u003C/code>\u003C/pre>\n\u003Cp>This will first clear the immutable flag off \u003Ccode>/etc/resolv.conf\u003C/code>, and delete it. Next, it will delete \u003Ccode>/etc/wsl.conf\u003C/code> if you have a backup of a previous \u003Ccode>wsl.conf\u003C/code> file, you can replace it with that. At last, we shutdown WSL again for the changes to take effect.\u003C/p>\n\u003Cp>Unfortunately, this is quite a procedure to get a VPN to work with WSL2, but I'm hopeful that this will soon not be necessairy anymore.\u003C/p>",slug:"blog/2023-03-21-anyconnect-wsl2",uuid:"c67bc4dc-4c96-41b1-afb5-15a99457dedf",date:new Date(1678893724511),created:new Date(1678893724511),aliases:[null],title:"Fix Network Connectivity in WSL2 with Cisco AnyConnect VPN",published:true,modified:null,description:"I ran into problems using Cisco AnyConnect VPN from inside of WSL2. I'm sharing my solution as a step-by-step guide for my reference and to help anyone with the same problem.",cover_image:"https://media.tiim.ch/66ca4290-3fc0-450f-977b-f00f888e4af3.webp",cover_image_txt:"Stable Diffusion - Anything V3.0 - 1boy, hacker, in front of computer, back of head visible, vintage neon color scheme, terminal, big monitor",content_tags:["wsl","vpn","networking","dns"],abstract:"\u003Cp>I recently ran into the problem that when the Cisco AnyConnect VPN is connected, the network connectivity inside of WSL2 stops working. I found a bunch of solutions online for it: most just focus on the fact that the VPN DNS settings are not applied inside WSL2 and therefore no domain names can be resolved. I additionally had the issue that the WSL2 network interface somehow gets disconnected when the VPN starts.\u003C/p>",tags:["dns","networking","vpn","wsl"],links:void 0,type:"article",folder:"blog",comments:[{id:"ebe11171-5e39-450b-bfad-e976f7659489",type:"comment",replyTo:"",timestamp:"2024-01-12T12:11:32Z",page:"blog/2023-03-21-anyconnect-wsl2",url:"https://tiim.ch/blog/2023-03-21-anyconnect-wsl2#ebe11171-5e39-450b-bfad-e976f7659489",content:"Thank you Tim! Had an issue where WSL network was working for some users and not others when using Cisco AnyConnect, network traffic seemed to go back to the AnyConnect interface and didn't reach WSL. Solution 1 did the trick for me!",name:"Neil"}],latestComment:"2024-01-20T09:36:14Z"},about:{html:"\u003Cp>Hi, my name is \u003Cspan class=\"p-name\">Tim Bachmann\u003C/span>!\nI'm a \u003Cspan class=\"p-role\">master graduate in computer science\u003C/span> at \u003Cspan class=\"p-org\">University of Basel\u003C/span>, swimmer and swim coach.\u003C/p>\n\u003Cp>I am passionate about all things web development, swimming, personal knowledge management and much more.\nIf you liked this or any of my posts, feel free to \u003Ca href=\"https://tiim.ch/follow\" rel=\"nofollow noopener noreferrer\">follow me\u003C/a>.\u003C/p>",slug:"about",uuid:"d8e56802-2847-4053-b213-9b004f1b965c",date:new Date(1665792000000),created:new Date(1665863229652),published:true,abstract:"\u003Cp>Hi, my name is {{name}}!\nI'm a {{role}} at {{org}}, swimmer and swim coach.\u003C/p>",tags:[],links:void 0,type:"article",cover_image:void 0,description:"",folder:"metadata"}},"uses":{"params":["slug"]}}];

					Promise.all([
						import("../_app/immutable/entry/start.5c58580c.js"),
						import("../_app/immutable/entry/app.8dd63c07.js")
					]).then(([kit, app]) => {
						kit.start(app, element, {
							node_ids: [0, 4],
							data,
							form: null,
							error: null
						});
					});
				}
			</script>
		</div>
  </body>
</html>
